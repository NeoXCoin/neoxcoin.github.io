<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NeoX Game (iframe host)</title>
<style>
  :root { --vh: 1vh; }

  html, body {
    margin: 0;
    background: #0a0b1f;
    color: #fff;
    height: calc(var(--vh, 1vh) * 100);
    display: grid;
    place-items: center;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang TC", "Noto Sans", Arial, sans-serif;
    overflow: hidden;
    overscroll-behavior: none;
    -webkit-overflow-scrolling: auto;
    touch-action: manipulation;
  }

  /* åŸºæœ¬ï¼šä»¥å¯¬åº¦ç‚ºä¸»ï¼ˆæ‰‹æ©Ÿã€çª„è¦–çª—ï¼‰ */
  iframe{
    width: min(96vw, 760px);   /* å…ˆæ¯”ä½ åŸæœ¬ 440px å¤§å¥½å¤šï¼ŒæŒ‰éœ€è¦å¯èª¿ */
    aspect-ratio: 9 / 16;
    height: auto;

    border: 0;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,.45);
    background: #000;

    /* iOS safe-areaï¼ˆå°æ¡Œé¢ç„¡å®³ï¼‰ */
    padding: constant(safe-area-inset-top) constant(safe-area-inset-right)
             constant(safe-area-inset-bottom) constant(safe-area-inset-left);
    padding: env(safe-area-inset-top) env(safe-area-inset-right)
             env(safe-area-inset-bottom) env(safe-area-inset-left);
  }

  /* æ¡Œé¢ï¼šä»¥é«˜åº¦ç‚ºä¸»ï¼Œè‡ªå‹•æ”¾å¤§ï¼ˆä¿æŒ 9:16ï¼‰ */
  @media (min-width: 900px) and (min-height: 700px){
    iframe{
      height: min(96vh, 1080px);  /* æœ€é«˜ 1080pxï¼Œé«˜åº¦ 96% è¦–çª— */
      width: auto;                /* aspect-ratio æœƒè‡ªå‹•è¨ˆå¯¬åº¦ */
    }
  }

  /* ç‰¹é—Š/ç‰¹é«˜è¢å¹•å†åŠ å¤§å°‘å°‘ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰ */
  @media (min-width: 1400px) and (min-height: 900px){
    iframe{
      height: min(97vh, 1180px);
    }
  }
  
  /* âœ… iPadï¼å¹³æ¿ç›´å‘ï¼šä»¥é«˜åº¦ç‚ºä¸»ï¼Œé ç•™åº•éƒ¨å®‰å…¨å€ï¼Œé¿å…è¢«é® */
  @media (orientation: portrait) and (min-width: 768px){
    iframe{
      /* å–è¼ƒä¿å®ˆçš„ 88% å¯è¦–é«˜åº¦ï¼ˆä½ å¯æŒ‰éœ€è¦æ”¹ 86/84ï¼‰ */
      height: min(88svh,
                  calc(var(--vh, 1vh) * 88),
                  calc(100dvh - 32px - env(safe-area-inset-bottom)));
      width: auto;           /* ç”± aspect-ratio è‡ªå‹•ç®—å¯¬ */
      aspect-ratio: 9 / 16;  /* ä¿æŒ 9:16 æ¯”ä¾‹ */
      max-width: 92vw;       /* ä»ç„¶ä¸è¶…å‡ºè¦–çª—å¯¬ */
    }
  }

  /* ğŸ† Top 3 Box */
  .top3 {
    position: fixed;
    top: 16px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,.08);
    border-radius: 12px;
    padding: 10px 16px;
    font-weight: 800;
    font-size: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,.3);
    backdrop-filter: blur(6px);
    display: none;
    opacity: 0;
    transition: opacity .6s ease;
    max-width: min(92vw, 440px);
  }
  .top3.show { display: block; opacity: 1; }
  .top3 ol { margin: 6px 0 0; padding-left: 20px; }
  .top3 small { opacity: .8; font-weight: 600; display:block; margin-top: 6px; }
</style>
</head>
<body>

<!-- ğŸ® èµ·å§‹é ï¼šæ•´å€‹éŠæˆ²æµç¨‹ï¼ˆç”¨çµ•å° URL + æ——æ¨™ï¼‰ -->
<iframe
  id="game"
  title="NeoX Catch"
  src="https://neoxcoin.github.io/neox-game/index.html#embed=1"
  allow="autoplay *; fullscreen *; gamepad *; clipboard-write"
  referrerpolicy="no-referrer-when-downgrade"
  loading="eager">
</iframe>

<!-- ğŸ† å…¨çƒæ’è¡Œæ¦œ -->
<div class="top3" id="top3Box">
  <div>ğŸ† NeoX Top 3 Players</div>
  <ol id="top3List"><li>Loading...</li></ol>
  <small id="top3Hint"></small>
</div>

<!-- ğŸ”§ å›ºå®šå¯è¦–é«˜åº¦ï¼ˆé˜² iOS åœ°å€åˆ—å°è‡´é«˜åº¦è·³å‹•ï¼‰ -->
<script>
  (function setVh(){
    function update(){
      var h = (window.visualViewport ? visualViewport.height : window.innerHeight);
      document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
    }
    update();
    window.addEventListener('resize', update, {passive:true});
    window.addEventListener('orientationchange', update, {passive:true});
    if (window.visualViewport) {
      visualViewport.addEventListener('resize', update, {passive:true});
      visualViewport.addEventListener('scroll', update, {passive:true});
    }
  })();
</script>

<script>
/* ====== ğŸŒ API Config ====== */
const API_URL     = 'https://script.google.com/macros/s/AKfycbw44w4f5hpmKiledO1XfIKsGgfMgCksmcU2Qsst56l68CPLvQs4GvIg0PrItIuUqkOT2g/exec';
const GAME_ORIGIN = 'https://neoxcoin.github.io';
const GAME_BASE   = 'https://neoxcoin.github.io/neox-game/';
const frame       = document.getElementById('game');

/* ====== ğŸ‘¤ Player Name (é¦–æ¬¡è©¢å•) ====== */
function getPlayerName(){
  let name = localStorage.getItem('nx_player_name');
  if(!name){
    name = prompt('Enter your player name for the leaderboard:','Player') || 'Player';
    name = String(name).slice(0,20);
    localStorage.setItem('nx_player_name', name);
  }
  return name;
}

/* ====== ğŸ† Fetch Top 3 from Google Script ====== */
async function loadTop3(){
  const box = document.getElementById('top3Box');
  const list = document.getElementById('top3List');
  const hint = document.getElementById('top3Hint');
  try{
    const res  = await fetch(API_URL, { cache:'no-cache' });
    const data = await res.json();
    list.innerHTML = '';
    (data||[]).slice(0,3).forEach(r=>{
      const li=document.createElement('li');
      li.textContent = `${r.name} â€” ${r.score}`;
      list.appendChild(li);
    });
    if(!list.children.length) list.innerHTML='<li>No scores yet</li>';
    hint.textContent='Updated: '+new Date().toLocaleTimeString();
    box.classList.add('show');
  }catch(e){
    list.innerHTML='<li>Network error</li>';
  }
}

/* ====== ğŸ“¨ Upload score to Google Script ====== */
async function submitScore(score){
  try{
    await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ name:getPlayerName(), score:Math.floor(score||0) })
    });
  }catch(e){}
}

/* ====== ğŸ”’ å®‰å…¨æ¥æ”¶ postMessageï¼ˆåªæ¥å—ä¾†è‡ª neoxcoin.github.ioï¼‰ ====== */
window.addEventListener('message', async (event)=>{
  if (event.origin !== GAME_ORIGIN) return;       // å®‰å…¨ï¼šå¿½ç•¥æœªçŸ¥ä¾†æº
  const m = event.data || {};
  // å¯é¸ï¼šconsole.log('MSG from game:', m);

  // ä½ ç¾æœ‰ v2/v3 å…§å·² postMessage NX_CARRYï¼Œå¯åœ¨é€™è£¡åšçˆ¶é  UIï¼ˆä¾‹å¦‚æ”¹æ¨™é¡Œï¼‰
  if (m.type === 'NX_CARRY' && typeof m.score === 'number') {
    document.title = `NeoX Game â€” Score ${m.score}`;
  }

  // ğŸ éŠæˆ²å®Œæˆï¼ˆç«¯å…§è«‹ç™¼é€™å€‹ï¼‰
  if (m.type === 'NX_GAME_CLEARED') {
    const total = Math.floor(m.total ?? m.score ?? 0);
    await submitScore(total);   // ä¸Šå‚³åˆ†æ•¸
    await loadTop3();           // å–æ¦œé¡¯ç¤º
  }
});

/* ====== ğŸ“¤ å°å­é ï¼ˆiframeï¼‰ä¸‹ç™¼ç©å®¶åç¨±ï¼ˆå¯é¸ï¼Œä¾›å­é å±•ç¤ºï¼‰ ====== */
function sendPlayerName(){
  const name = getPlayerName();
  try{ frame.contentWindow?.postMessage({ type:'NX_PLAYER_NAME', name }, GAME_ORIGIN); }catch(e){}
}
window.addEventListener('load', sendPlayerName);
</script>
</body>
</html>