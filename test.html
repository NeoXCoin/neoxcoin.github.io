<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>NeoX Star Dodger</title>
  <style>
    /* â€”â€” åŸºæœ¬æ¨£å¼ â€”â€” */
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1200px 800px at 50% 30%, #0e1440 0%, #090b24 60%, #050614 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Heiti TC", "PingFang TC", "Noto Sans TC", Arial, sans-serif;
      color: #fff;
      overflow: hidden; /* é¿å…æ»¾å‹• */
    }
    #wrap {
      position: relative;
      height: 100%;
      display: grid;
      place-items: center;
    }
    canvas {
      display: block;
      width: min(92vw, 700px);
      height: auto;
      aspect-ratio: 9/16; /* æ‰‹æ©Ÿç›´å‘æ¯”ä¾‹ */
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(16,18,52,.8), rgba(10,12,34,.9));
      touch-action: none; /* æ””æˆªæ‰‹å‹¢é¿å…é é¢æ»‘å‹• */
    }
    /* HUD èˆ‡æŒ‰éˆ• */
    .hud {
      position: absolute; inset: 0;
      display: grid; grid-template-rows: auto 1fr auto;
      pointer-events: none; /* é è¨­ä¸åƒäº‹ä»¶ï¼ŒæŒ‰éˆ•å„è‡ªé–‹å•Ÿ */
    }
    .topbar {
      display:flex; justify-content: space-between; align-items:center;
      gap:10px; padding: 10px 14px;
      font-weight: 600; letter-spacing:.3px;
      text-shadow: 0 1px 0 rgba(0,0,0,.5);
    }
    .badge {
      padding:6px 10px; border-radius:10px; background: rgba(255,255,255,.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .buttons { display:flex; gap:8px; }
    button {
      pointer-events: auto;
      border:0; border-radius:10px; padding:8px 12px; font-weight:700;
      background: #2b7cff; color:white; cursor:pointer;
      box-shadow: 0 6px 18px rgba(43,124,255,.35);
      transition: transform .06s ease, filter .2s ease;
    }
    button.alt { background: #1f2648; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
    button:active { transform: translateY(1px) scale(.99); filter: brightness(.95); }

    /* ä¸­å¤®è¨Šæ¯é¢æ¿ï¼ˆé–‹å§‹/çµæŸ/æš«åœï¼‰ */
    .center {
      display:grid; place-items:center; padding: 10px;
    }
    .panel {
      pointer-events:auto;
      min-width: clamp(240px, 80%, 520px);
      text-align:center; padding: 18px 16px 20px;
      border-radius: 14px;
      background: rgba(10,12,34,.85);
      box-shadow: 0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06);
      backdrop-filter: blur(4px);
    }
    .panel h1 { margin: 8px 0 6px; font-size: clamp(20px, 4.8vw, 28px); }
    .panel p { margin: 6px 0 14px; color: #b9c1ff; font-size: 14px; line-height: 1.5; }
    .panel .row { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }
    .hidden { display:none !important; }

    /* è§¸æ§å€åŸŸæç¤ºï¼ˆå·¦å³åŠå±ï¼‰ */
    .touch-hints {
      position: absolute; inset: 0; display:grid; grid-template-columns: 1fr 1fr;
      pointer-events:none; opacity:.1;
    }
    .touch-hints > div { border: 1px dashed rgba(255,255,255,.1); margin: 6px; border-radius: 12px; }
    @media (hover:hover) and (pointer:fine) {
      .touch-hints { display:none; }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="450" height="800" aria-label="NeoX Star Dodger"></canvas>

    <!-- HUD -->
    <div class="hud" aria-live="polite">
      <div class="topbar">
        <div class="badge" id="scoreBadge">åˆ†æ•¸ï¼š0</div>
        <div class="buttons">
          <button id="btnPause" class="alt" title="æš«åœ/ç¹¼çºŒ (P)">â¸ æš«åœ</button>
          <button id="btnRestart" title="é‡æ–°é–‹å§‹ (R)">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
      </div>

      <div class="center">
        <div id="panelStart" class="panel">
          <h1>NeoX Star Dodger</h1>
          <p>å·¦å³ç§»å‹•é–ƒé¿éš•çŸ³ï¼Œåƒåˆ°æ˜Ÿæ˜Ÿå¯é¡å¤–åŠ åˆ†ã€‚<br>
             éµç›¤ <b>â† â†’</b> æˆ–æ‹–æ›³ï¼é»æŒ‰å·¦å³åŠé‚Šè¢å¹•ç§»å‹•ã€‚<br>
             éŠæˆ²ä¸­å¯æŒ‰ <b>P</b> æš«åœï¼Œ<b>R</b> é‡é–‹ã€‚</p>
          <div class="row">
            <button id="btnStart">â–¶ é–‹å§‹éŠæˆ²</button>
          </div>
        </div>

        <div id="panelPause" class="panel hidden">
          <h1>æš«åœä¸­</h1>
          <p>ç¨ä½œä¼‘æ¯ã€‚æº–å‚™å¥½äº†å°±ç¹¼çºŒå§ï¼</p>
          <div class="row">
            <button id="btnResume">âµ ç¹¼çºŒ</button>
            <button id="btnRestart2" class="alt">ğŸ”„ é‡é–‹</button>
          </div>
        </div>

        <div id="panelGameOver" class="panel hidden">
          <h1>éŠæˆ²çµæŸ</h1>
          <p><span id="finalScore">åˆ†æ•¸ï¼š0</span><br><span id="bestScore">æœ€ä½³ï¼š0</span></p>
          <div class="row">
            <button id="btnPlayAgain">å†ä¾†ä¸€æ¬¡</button>
          </div>
        </div>
      </div>

      <!-- è§¸æ§å€å¡Šæç¤ºï¼ˆåƒ…è¡Œå‹•è£ç½®æœƒçœ‹åˆ°ä¸€é»é»ç·šæ¡†ï¼‰ -->
      <div class="touch-hints" aria-hidden="true">
        <div></div><div></div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // NeoX Star Dodger ä¸»ç¨‹å¼
    // =========================
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // ç‚ºäº†è¦–ç¶²è†œè¢å¹•æ¸…æ™°ï¼Œå‹•æ…‹ scale ç•«å¸ƒ
    function fitHiDPI() {
      const cssWidth = canvas.clientWidth;
      const cssHeight = canvas.clientHeight;
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      if (canvas.width !== Math.round(cssWidth * dpr)) {
        canvas.width = Math.round(cssWidth * dpr);
        canvas.height = Math.round(cssHeight * dpr);
      }
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // ä¹‹å¾Œä¸€å¾‹ç”¨ CSS å°ºå¯¸ä½œåº§æ¨™
    }
    fitHiDPI();
    addEventListener('resize', fitHiDPI);

    // â€”â€” éŠæˆ²ç‹€æ…‹ â€”â€” //
    const State = { READY:0, PLAYING:1, PAUSED:2, OVER:3 };
    let gameState = State.READY;

    // ç©å®¶ç‰©ä»¶
    const player = {
      x: 225, y: 720, r: 14,
      speed: 5.2, vx: 0,
      color1: '#59b1ff', color2: '#2b7cff'
    };

    // ç‰©ä»¶æ± 
    const meteors = [];  // éš•çŸ³ï¼ˆéœ€é–ƒé¿ï¼‰
    const stars = [];    // æ˜Ÿæ˜Ÿï¼ˆå¯åƒï¼‰
    let spawnTimer = 0;
    let score = 0;
    let best = Number(localStorage.getItem('neox_dodger_best') || 0);
    const scoreBadge = document.getElementById('scoreBadge');

    // è¼¸å…¥ï¼ˆéµç›¤èˆ‡è§¸æ§ï¼‰
    const keys = new Set();
    addEventListener('keydown', e => {
      if (e.repeat) return;
      if (e.key === 'ArrowLeft') keys.add('L');
      if (e.key === 'ArrowRight') keys.add('R');
      if (e.key.toLowerCase() === 'p') togglePause();
      if (e.key.toLowerCase() === 'r') restart();
      if (gameState === State.READY && (e.key === ' ' || e.key === 'Enter')) start();
    });
    addEventListener('keyup', e => {
      if (e.key === 'ArrowLeft') keys.delete('L');
      if (e.key === 'ArrowRight') keys.delete('R');
    });

    // è§¸æ§/æ»‘é¼ ï¼ˆå·¦å³åŠå±ï¼‰
    let pointerId = null;
    let pointerX = null;
    function pointerDown(e) {
      const p = (e.changedTouches && e.changedTouches[0]) || e;
      pointerId = p.identifier ?? 'mouse';
      pointerX = p.clientX;
      if (gameState === State.READY) start();
      e.preventDefault();
    }
    function pointerMove(e) {
      const p = (e.changedTouches && ([...e.changedTouches].find(t => (t.identifier ?? 'mouse') === pointerId))) || e;
      if (p && pointerX != null) {
        const rect = canvas.getBoundingClientRect();
        const cx = (p.clientX - rect.left) / rect.width * canvas.clientWidth;
        // ä»¥ç›®æ¨™ x æ…¢æ…¢é è¿‘
        const diff = cx - player.x;
        player.vx = Math.max(-player.speed, Math.min(player.speed, diff * 0.25));
      }
      e.preventDefault();
    }
    function pointerUp(e) { pointerId = null; pointerX = null; player.vx = 0; e.preventDefault(); }

    canvas.addEventListener('pointerdown', pointerDown, {passive:false});
    addEventListener('pointermove', pointerMove, {passive:false});
    addEventListener('pointerup', pointerUp, {passive:false});
    addEventListener('pointercancel', pointerUp, {passive:false});
    addEventListener('blur', () => { if (gameState === State.PLAYING) togglePause(true); });

    // â€”â€” UI é¢æ¿ â€”â€” //
    const panelStart = document.getElementById('panelStart');
    const panelPause = document.getElementById('panelPause');
    const panelOver  = document.getElementById('panelGameOver');
    const finalScore = document.getElementById('finalScore');
    const bestScore  = document.getElementById('bestScore');

    document.getElementById('btnStart').onclick = start;
    document.getElementById('btnPause').onclick = () => togglePause();
    document.getElementById('btnResume').onclick = () => togglePause(false);
    document.getElementById('btnRestart').onclick = restart;
    document.getElementById('btnRestart2').onclick = restart;
    document.getElementById('btnPlayAgain').onclick = restart;

    function show(el, show=true){ el.classList.toggle('hidden', !show); }
    function refreshHUD(){
      scoreBadge.textContent = `åˆ†æ•¸ï¼š${Math.floor(score)}`;
      bestScore.textContent  = `æœ€ä½³ï¼š${Math.floor(best)}`;
      finalScore.textContent = `åˆ†æ•¸ï¼š${Math.floor(score)}`;
    }

    function start(){
      score = 0;
      meteors.length = 0;
      stars.length = 0;
      spawnTimer = 0;
      player.x = canvas.clientWidth/2;
      player.y = canvas.clientHeight*0.9;
      player.vx = 0;
      gameState = State.PLAYING;
      show(panelStart, false);
      show(panelPause, false);
      show(panelOver,  false);
      document.getElementById('btnPause').textContent = 'â¸ æš«åœ';
    }
    function togglePause(forcePause){
      if (gameState === State.PLAYING && (forcePause ?? true)) {
        gameState = State.PAUSED;
        show(panelPause, true);
        document.getElementById('btnPause').textContent = 'âµ ç¹¼çºŒ';
      } else if (gameState === State.PAUSED) {
        gameState = State.PLAYING;
        show(panelPause, false);
        document.getElementById('btnPause').textContent = 'â¸ æš«åœ';
      }
    }
    function gameOver(){
      gameState = State.OVER;
      best = Math.max(best, Math.floor(score));
      localStorage.setItem('neox_dodger_best', String(best));
      refreshHUD();
      show(panelOver, true);
    }
    function restart(){
      show(panelOver, false);
      show(panelPause, false);
      start();
    }

    // â€”â€” å·¥å…· â€”â€” //
    function rand(min, max){ return Math.random()*(max-min)+min; }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function circleRectCollide(cx, cy, r, rx, ry, rw, rh){
      // åœ“å½¢èˆ‡çŸ©å½¢ç¢°æ’
      const nx = clamp(cx, rx, rx + rw);
      const ny = clamp(cy, ry, ry + rh);
      const dx = cx - nx, dy = cy - ny;
      return (dx*dx + dy*dy) <= r*r;
    }

    // â€”â€” ç”Ÿæˆç‰©ä»¶ â€”â€” //
    function spawnEntities(dt){
      spawnTimer -= dt;
      if (spawnTimer <= 0){
        // é›£åº¦æœƒéš¨æ™‚é–“æå‡
        const level = 1 + Math.min(3, Math.floor(score / 200));
        const meteorCount = 1 + Math.floor(Math.random()*level);
        for (let i=0;i<meteorCount;i++){
          meteors.push({
            x: rand(20, canvas.clientWidth-40), y: -30,
            w: rand(18, 36), h: rand(18, 36),
            vy: rand(2.6, 3.8) + level*0.4,
            rot: rand(0,Math.PI*2), vr: rand(-0.08,0.08)
          });
        }
        // å°æ©Ÿç‡ç”¢ç”Ÿæ˜Ÿæ˜Ÿ
        if (Math.random() < 0.55){
          stars.push({
            x: rand(20, canvas.clientWidth-20), y: -18,
            r: 9, vy: rand(2.4, 3.2) + Math.min(2, score/250)
          });
        }
        spawnTimer = Math.max(0.35, 1.15 - score/200); // è¶Šä¾†è¶Šå¯†é›†
      }
    }

    // â€”â€” æ›´æ–°é‚è¼¯ â€”â€” //
    let last = performance.now();
    function loop(now){
      requestAnimationFrame(loop);
      fitHiDPI();
      const dt = Math.min(50, now - last) / 16.6667; // ä»¥ 60fps ç‚ºåŸºæº–
      last = now;

      // ç•«èƒŒæ™¯æ˜Ÿé»
      drawBackground(now);

      if (gameState === State.PLAYING){
        // ç©å®¶ç§»å‹•
        player.vx = (keys.has('L') ? -player.speed : 0) + (keys.has('R') ? player.speed : 0) || player.vx*0.92;
        player.x += player.vx;
        player.x = clamp(player.x, player.r+6, canvas.clientWidth - player.r - 6);

        // ç”¢ç”Ÿ/æ›´æ–°ç‰©ä»¶
        spawnEntities(dt);
        for (let m of meteors){ m.y += m.vy * dt; m.rot += m.vr * dt; }
        for (let s of stars){ s.y += s.vy * dt; }

        // ç¢°æ’æª¢æŸ¥
        for (let i=meteors.length-1; i>=0; i--){
          const m = meteors[i];
          if (circleRectCollide(player.x, player.y, player.r, m.x, m.y, m.w, m.h)) {
            gameOver();
          }
          if (m.y > canvas.clientHeight + 40) meteors.splice(i,1);
        }
        for (let i=stars.length-1; i>=0; i--){
          const s = stars[i];
          const dx = s.x - player.x, dy = s.y - player.y;
          if (dx*dx + dy*dy <= (s.r + player.r)*(s.r + player.r)) {
            score += 25; // åƒæ˜Ÿæ˜ŸåŠ åˆ†
            stars.splice(i,1);
          } else if (s.y > canvas.clientHeight + 30) {
            stars.splice(i,1);
          }
        }

        // åˆ†æ•¸éš¨æ™‚é–“å¢åŠ 
        score += 0.9 * dt;
        refreshHUD();
      }

      // ç¹ªè£½ç©å®¶èˆ‡ç‰©ä»¶
      drawPlayer();
      drawMeteors();
      drawStars();

      // æç¤ºæ–‡å­—ï¼ˆæœªé–‹å§‹ï¼‰
      if (gameState === State.READY){
        tipText('é»æ“Šæˆ–æŒ‰ç©ºç™½éµé–‹å§‹', canvas.clientWidth/2, canvas.clientHeight*0.6);
      }
    }
    requestAnimationFrame(loop);

    // â€”â€” è¦–è¦ºç¹ªè£½ â€”â€” //
    function drawBackground(t){
      const w = canvas.clientWidth, h = canvas.clientHeight;
      ctx.clearRect(0,0,w,h);

      // æ¼¸å±¤å…‰æšˆ
      const g = ctx.createRadialGradient(w*0.5, h*0.25, 20, w*0.5, h*0.25, h*0.9);
      g.addColorStop(0, 'rgba(80,110,255,0.10)');
      g.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // æ˜Ÿå¡µé»
      ctx.globalAlpha = 0.6;
      ctx.fillStyle = 'rgba(255,255,255,0.8)';
      for (let i=0;i<36;i++){
        const x = (t*0.02 + i*97) % w;
        const y = (t*0.06 + i*53) % h;
        ctx.fillRect(x, y, 1, 1);
      }
      ctx.globalAlpha = 1;
    }

    function drawPlayer(){
      const x = player.x, y = player.y, r = player.r;
      // å¤–åœˆå…‰æšˆ
      const grad = ctx.createRadialGradient(x, y, 2, x, y, r*2.2);
      grad.addColorStop(0, 'rgba(90,180,255,0.9)');
      grad.addColorStop(1, 'rgba(90,180,255,0)');
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(x,y,r*2.2,0,Math.PI*2); ctx.fill();

      // ä¸»é«”æ¼¸å±¤çƒ
      const g = ctx.createLinearGradient(x, y-r, x, y+r);
      g.addColorStop(0, player.color1);
      g.addColorStop(1, player.color2);
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

      // äº®é»
      ctx.fillStyle = 'rgba(255,255,255,.8)';
      ctx.beginPath(); ctx.arc(x-r*0.35, y-r*0.35, r*0.25, 0, Math.PI*2); ctx.fill();
    }

    function drawMeteors(){
      ctx.save();
      for (let m of meteors){
        ctx.translate(m.x + m.w/2, m.y + m.h/2);
        ctx.rotate(m.rot);
        ctx.translate(-m.w/2, -m.h/2);
        // éš•çŸ³æœ¬é«”
        ctx.fillStyle = '#6e6f86';
        ctx.fillRect(0,0,m.w,m.h);
        // é‚Šæ¡†
        ctx.strokeStyle = 'rgba(255,255,255,.15)';
        ctx.strokeRect(0,0,m.w,m.h);
        ctx.setTransform(1,0,0,1,0,0);
      }
      ctx.restore();
    }

    function drawStars(){
      for (let s of stars){
        drawStar(s.x, s.y, s.r, 5);
      }
    }
    function drawStar(x, y, r, spikes){
      const outer = r, inner = r*0.5;
      let rot = Math.PI/2*3, cx = x, cy = y;
      ctx.beginPath();
      ctx.moveTo(cx, cy - outer);
      for (let i=0; i<spikes; i++){
        ctx.lineTo(cx + Math.cos(rot)*outer, cy + Math.sin(rot)*outer);
        rot += Math.PI/spikes;
        ctx.lineTo(cx + Math.cos(rot)*inner, cy + Math.sin(rot)*inner);
        rot += Math.PI/spikes;
      }
      ctx.lineTo(cx, cy - outer);
      ctx.closePath();
      ctx.fillStyle = '#ffd76b';
      ctx.shadowColor = '#ffd76b';
      ctx.shadowBlur = 12;
      ctx.fill();
      ctx.shadowBlur = 0;
    }

    function tipText(text, x, y){
      ctx.font = '600 18px system-ui, -apple-system, "Segoe UI"';
      ctx.textAlign = 'center';
      ctx.fillStyle = 'rgba(255,255,255,.9)';
      ctx.fillText(text, x, y);
    }

    // åˆå§‹ HUD æ›´æ–°
    refreshHUD();
  </script>
</body>
</html>