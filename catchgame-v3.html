 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>NeoX Catch the Coins â€“ v3 (single)</title>
<meta name="theme-color" content="#0a0b1f">
<style>
  :root{ --safe-top: env(safe-area-inset-top); }
  html, body { height:100%; margin:0; background:#0a0b1f; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang TC","Noto Sans TC",Arial,sans-serif; overflow:hidden;}
  #wrap { position:relative; height:100%; display:grid; place-items:center; }
  canvas {
    display:block; width:min(92vw,700px); aspect-ratio:9/16; height:auto;
    border-radius:16px; background:linear-gradient(180deg,#0f1240,#0a0c22);
    box-shadow:0 20px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
    touch-action:none;
  }
  .hud { position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr auto; pointer-events:none;}
  .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:calc(10px + var(--safe-top)) 14px 10px; font-weight:700; }
  .badges{ display:flex; gap:8px; flex-wrap:wrap;}
  .badge{ padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.08); box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);}
  .buttons{ display:flex; gap:8px; }
  button, select{ pointer-events:auto; border:0; border-radius:10px; padding:8px 12px; font-weight:700; background:#1f2648; color:#fff; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
  button.primary{ background:#2b7cff; color:#fff; box-shadow:0 6px 18px rgba(43,124,255,.35); }
  .center{ display:grid; place-items:center; padding:10px;}
  .panel{ pointer-events:auto; min-width:clamp(260px,82%,560px); text-align:center; padding:18px 16px 20px; border-radius:14px; background:rgba(10,12,34,.85); box-shadow:0 20px 60px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06); backdrop-filter: blur(4px); }
  .panel h1{ margin:8px 0 6px; font-size: clamp(20px,4.8vw,28px);}
  .panel p{ margin:6px 0 14px; color:#b9c1ff; font-size:14px; line-height:1.5;}
  .panel .row{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap;}
  .hidden{ display:none !important; }
  .level-banner{ position:absolute; left:50%; top:60px; transform:translateX(-50%); background:rgba(255,255,255,.08); border-radius:999px; padding:8px 14px; font-weight:800; letter-spacing:.3px; pointer-events:none; }
  .leaderboard { text-align:left; margin-top:10px; background:rgba(255,255,255,.05); border-radius:10px; padding:10px; }
  .leaderboard h3{ margin:6px 0 8px; font-size:16px; }
  .leaderboard ol{ margin:0; padding-left:22px; }
  .leaderboard li{ margin:4px 0; }
  .field { display:flex; gap:8px; justify-content:center; align-items:center; margin-top:8px;}
  .field input{ width: 60%; max-width: 260px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#111638; color:#fff; }
  .note { color:#9fb0ff; font-size:13px; }

  /* HUD é¡å¤–çµ±è¨ˆçš„æ”¶åˆ */
  .extraStat { display:none; }
  #hudBar.show-all .extraStat { display:inline-block; }

  /* é–‹å ´å‹•ç•« */
  #splash{ position:absolute; inset:0; display:grid; place-items:center; background: radial-gradient(1200px 800px at 50% 30%, #0e1440 0%, #090b24 60%, #050614 100%); z-index: 9; }
  #neoxLogo{ font-weight:900; font-size: clamp(28px, 8vw, 54px); letter-spacing:.1em; text-shadow:0 0 18px rgba(80,150,255,.55), 0 0 36px rgba(80,150,255,.25); filter: drop-shadow(0 6px 24px rgba(0,0,0,.6)); opacity:0; transform: translateY(8px) scale(.98); transition: opacity .8s ease, transform .8s ease; }
  #splashHint{ margin-top:10px; color:#b9c1ff; opacity:0; transition: opacity .6s .5s; }
</style>
</head>
<body>
  <div id="wrap">
    <canvas id="game" width="450" height="800" aria-label="NeoX Catch the Coins â€“ v3"></canvas>

    <div class="hud" aria-live="polite">
      <div class="topbar">
        <div class="badges" id="hudBar">
          <div class="badge" id="scoreBadge">Score: 0</div>
          <div class="badge" id="levelBadge">Level 1 / 5</div>
          <div class="badge extraStat" id="progressBadge">Progress: 0 / 10</div>
          <div class="badge extraStat" id="comboBadge">Combo: 0</div>
          <div class="badge extraStat" id="multBadge">Multiplier: x1.0</div>
          <div class="badge extraStat" id="bestBadge">Best: 0</div>
          <button id="btnShowMore" class="alt" style="margin-left:8px;">ğŸ“Š Show Stats</button>
        </div>
        <div class="buttons">
          <select id="langSelect" title="Language"></select>
          <button id="btnSound"  class="alt" title="Sound (M)">ğŸ”Š Sound</button>
          <button id="btnPause"  class="alt" title="Pause/Resume (P)">â¸ Pause</button>
          <button id="btnRestart" class="primary" title="Restart (R)">ğŸ”„ Restart</button>
        </div>
      </div>

      <div class="center">
        <div id="panelStart" class="panel">
          <h1>NeoX Catch the Coins</h1>
          <p>
            Move the tray at the bottom to catch falling <b>NeoX Coins</b>.<br>
            <b>Bonus (blue) = x3</b> â€¢ Consecutive catches increase <b>Combo</b> (max x3) â€¢ Missing deducts points & resets Combo.<br>
            Clear each target to level up (5 levels). After winning you can save your name to the local leaderboard.
          </p>
          <div class="row"><button id="btnStart" class="primary">â–¶ Start</button></div>

          <div class="leaderboard" id="startLeaderboard">
            <h3>ğŸ† Leaderboard (Local)</h3>
            <ol id="lbListStart"></ol>
            <div class="note">Tip: leaderboard is only stored in your browser (localStorage).</div>
          </div>
        </div>

        <div id="panelPause" class="panel hidden">
          <h1>Paused</h1>
          <p>Ready to continue?</p>
          <div class="row">
            <button id="btnResume" class="primary">âµ Resume</button>
            <button id="btnRestart2" class="alt">ğŸ”„ Restart</button>
          </div>
        </div>

        <div id="panelWin" class="panel hidden">
          <h1>Congrats!</h1>
          <p><span id="finalScore">Score: 0</span><br><span id="bestScore">Best: 0</span></p>
          <div class="field">
            <input id="nameInput" type="text" maxlength="20" placeholder="Enter your name (max 20)"/>
            <button id="btnSaveScore" class="primary">ğŸ’¾ Save to Leaderboard</button>
          </div>
          <div class="note" style="margin-top:6px;">(Stored locally in your browser)</div>
          <div class="leaderboard" style="margin-top:12px;">
            <h3>ğŸ“ Leaderboard (Local)</h3>
            <ol id="lbListWin"></ol>
          </div>
          <div class="row" style="margin-top:10px;"><button id="btnPlayAgain" class="primary">Play Again</button></div>
        </div>
      </div>

      <div class="level-banner hidden" id="levelBanner">LEVEL 1</div>
    </div>

    <!-- é–‹å ´å‹•ç•« -->
    <div id="splash">
      <div style="text-align:center;">
        <div id="neoxLogo">NEOX</div>
        <div id="splashHint">Loadingâ€¦</div>
      </div>
    </div>
  </div>

<script>
/* ===================== i18n (multi-language) ===================== */
const I18N = {
  en:{name:'English',
    score:'Score', level:'Level', progress:'Progress', best:'Best',
    combo:'Combo', mult:'Multiplier',
    start_title:'NeoX Catch the Coins',
    start_desc:'Move the tray at the bottom to catch falling NeoX Coins. <b>Bonus (blue) coin = x3 points</b>; consecutive catches increase <b>Combo</b> (max x3); missing a coin deducts points and resets Combo. Clear each goal to level up (5 levels). After you beat the game, you can save your name to the local leaderboard.',
    start_btn:'Start', sound:'Sound', pause_btn:'Pause', resume_btn:'Resume', restart_btn:'Restart',
    paused_title:'Paused', paused_desc:'Ready to continue?',
    win_title:'Congrats!', save_btn:'Save to Leaderboard',
    name_ph:'Enter your name (max 20)', lb_title:'Leaderboard (Local)', lb_note:'Tip: the leaderboard is only stored in your browser (localStorage).', play_again:'Play Again',
    show_stats:'ğŸ“Š Show Stats', hide_stats:'ğŸ“‰ Hide Stats'
  },
  'zh-Hant':{name:'ç¹é«”ä¸­æ–‡',
    score:'åˆ†æ•¸', level:'Level', progress:'é€²åº¦', best:'æœ€ä½³',
    combo:'Combo', mult:'ä¹˜æ•¸',
    start_title:'NeoX Catch the Coins',
    start_desc:'ç”¨åº•éƒ¨çš„ã€Œæ‰˜ç›¤ã€å·¦å³ç§»å‹•ï¼Œæ¥ä½æ‰ä¸‹ä¾†çš„ NeoX Coinã€‚<b>Bonus è—å¹£ = x3 åˆ†</b>ï¼›<b>é€£çºŒæ¥</b>æœƒæå‡ <b>Combo ä¹˜æ•¸</b>ï¼ˆä¸Šé™ x3ï¼‰ï¼›<b>æ¼æ¥æœƒæ‰£åˆ†ä¸¦æ¸… Combo</b>ã€‚å®Œæˆæ¯é—œç›®æ¨™æœƒå‡ç´šï¼ˆå…± 5 é—œï¼‰ã€‚é€šé—œå¾Œå¯æŠŠåå­—å„²å­˜åˆ°æœ¬æ©Ÿæ’è¡Œæ¦œã€‚',
    start_btn:'é–‹å§‹éŠæˆ²', sound:'éŸ³æ•ˆ', pause_btn:'æš«åœ', resume_btn:'ç¹¼çºŒ', restart_btn:'é‡æ–°é–‹å§‹',
    paused_title:'æš«åœä¸­', paused_desc:'æº–å‚™å¥½å°±ç¹¼çºŒå§ï¼',
    win_title:'æ­å–œé€šé—œï¼', save_btn:'å„²å­˜åˆ°æ’è¡Œæ¦œ',
    name_ph:'è¼¸å…¥ä½ çš„åå­—ï¼ˆæœ€å¤š20å­—ï¼‰', lb_title:'æ’è¡Œæ¦œï¼ˆæœ¬æ©Ÿï¼‰', lb_note:'æç¤ºï¼šæ’è¡Œæ¦œåªå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚', play_again:'å†ç©ä¸€æ¬¡',
    show_stats:'ğŸ“Š é¡¯ç¤ºçµ±è¨ˆ', hide_stats:'ğŸ“‰ éš±è—çµ±è¨ˆ'
  },
  'zh-Hans':{name:'ç®€ä½“ä¸­æ–‡',
    score:'åˆ†æ•°', level:'Level', progress:'è¿›åº¦', best:'æœ€ä½³',
    combo:'è¿å‡»', mult:'å€æ•°',
    start_title:'NeoX Catch the Coins',
    start_desc:'ç”¨åº•éƒ¨â€œæ‰˜ç›˜â€å·¦å³ç§»åŠ¨ï¼Œæ¥ä½æ‰ä¸‹æ¥çš„ NeoX Coinã€‚<b>è“è‰² Bonus = x3 åˆ†</b>ï¼›<b>è¿ç»­æ¥ä½</b>æå‡ <b>è¿å‡»å€æ•°</b>ï¼ˆä¸Šé™ x3ï¼‰ï¼›<b>æ¼æ¥ä¼šæ‰£åˆ†å¹¶æ¸…ç©ºè¿å‡»</b>ã€‚å®Œæˆæ¯å…³ç›®æ ‡å³å¯å‡çº§ï¼ˆå…± 5 å…³ï¼‰ã€‚é€šå…³åå¯å°†åå­—ä¿å­˜åˆ°æœ¬æœºæ’è¡Œæ¦œã€‚',
    start_btn:'å¼€å§‹æ¸¸æˆ', sound:'éŸ³æ•ˆ', pause_btn:'æš‚åœ', resume_btn:'ç»§ç»­', restart_btn:'é‡å¼€',
    paused_title:'å·²æš‚åœ', paused_desc:'å‡†å¤‡å¥½å°±ç»§ç»­å§ï¼',
    win_title:'æ­å–œé€šå…³ï¼', save_btn:'ä¿å­˜åˆ°æ’è¡Œæ¦œ',
    name_ph:'è¾“å…¥ä½ çš„åå­—ï¼ˆæœ€å¤š20å­—ï¼‰', lb_title:'æ’è¡Œæ¦œï¼ˆæœ¬æœºï¼‰', lb_note:'æç¤ºï¼šæ’è¡Œæ¦œä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨ï¼ˆlocalStorageï¼‰ã€‚', play_again:'å†ç©ä¸€æ¬¡',
    show_stats:'ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡', hide_stats:'ğŸ“‰ éšè—ç»Ÿè®¡'
  },
  ja:{name:'æ—¥æœ¬èª',
    score:'ã‚¹ã‚³ã‚¢', level:'ãƒ¬ãƒ™ãƒ«', progress:'é€²è¡Œ', best:'ãƒ™ã‚¹ãƒˆ',
    combo:'ã‚³ãƒ³ãƒœ', mult:'å€ç‡',
    start_title:'NeoX Catch the Coins',
    start_desc:'ä¸‹éƒ¨ã®ãƒˆãƒ¬ã‚¤ã‚’å·¦å³ã«å‹•ã‹ã—ã¦ NeoX ã‚³ã‚¤ãƒ³ã‚’ã‚­ãƒ£ãƒƒãƒã€‚<b>ãƒœãƒ¼ãƒŠã‚¹ï¼ˆé’ï¼‰= x3</b>ã€‚é€£ç¶šã‚­ãƒ£ãƒƒãƒã§<b>ã‚³ãƒ³ãƒœ</b>ä¸Šæ˜‡ï¼ˆæœ€å¤§ x3ï¼‰ã€å–ã‚Šé€ƒã—ã§æ¸›ç‚¹ï¼†ã‚³ãƒ³ãƒœè§£é™¤ã€‚å„ç›®æ¨™ã‚’é”æˆã—ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ˆå…¨5ï¼‰ã€‚ã‚¯ãƒªã‚¢å¾Œã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åå‰ã‚’ä¿å­˜ã§ãã¾ã™ã€‚',
    start_btn:'ã‚¹ã‚¿ãƒ¼ãƒˆ', sound:'ã‚µã‚¦ãƒ³ãƒ‰', pause_btn:'ä¸€æ™‚åœæ­¢', resume_btn:'å†é–‹', restart_btn:'ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ',
    paused_title:'ä¸€æ™‚åœæ­¢ä¸­', paused_desc:'æº–å‚™ãŒã§ããŸã‚‰å†é–‹ï¼',
    win_title:'ã‚¯ãƒªã‚¢ï¼', save_btn:'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ä¿å­˜',
    name_ph:'åå‰ã‚’å…¥åŠ›ï¼ˆæœ€å¤§20æ–‡å­—ï¼‰', lb_title:'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰', lb_note:'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚', play_again:'ã‚‚ã†ä¸€åº¦',
    show_stats:'ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º', hide_stats:'ğŸ“‰ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’éš ã™'
  },
  ko:{name:'í•œêµ­ì–´',
    score:'ì ìˆ˜', level:'ë ˆë²¨', progress:'ì§„í–‰', best:'ìµœê³ ',
    combo:'ì½¤ë³´', mult:'ë°°ìˆ˜',
    start_title:'NeoX Catch the Coins',
    start_desc:'í•˜ë‹¨ íŠ¸ë ˆì´ë¥¼ ì¢Œìš°ë¡œ ì›€ì§ì—¬ NeoX ì½”ì¸ì„ ë°›ìœ¼ì„¸ìš”. <b>ë³´ë„ˆìŠ¤(íŒŒë‘)= x3</b>. ì—°ì† ì„±ê³µ ì‹œ <b>ì½¤ë³´</b> ì¦ê°€(ìµœëŒ€ x3), ë†“ì¹˜ë©´ ê°ì  ë° ì½¤ë³´ ì´ˆê¸°í™”. ëª©í‘œ ë‹¬ì„± ì‹œ ë ˆë²¨ì—…(ì´ 5ë‹¨ê³„). í´ë¦¬ì–´ í›„ ë¡œì»¬ ë­í‚¹ì— ì´ë¦„ì„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    start_btn:'ì‹œì‘', sound:'ì‚¬ìš´ë“œ', pause_btn:'ì¼ì‹œì •ì§€', resume_btn:'ê³„ì†', restart_btn:'ì¬ì‹œì‘',
    paused_title:'ì¼ì‹œì •ì§€', paused_desc:'ì¤€ë¹„ë˜ë©´ ê³„ì†!',
    win_title:'ì¶•í•˜í•©ë‹ˆë‹¤!', save_btn:'ë­í‚¹ì— ì €ì¥',
    name_ph:'ì´ë¦„ ì…ë ¥(ìµœëŒ€ 20ì)', lb_title:'ë­í‚¹(ë¡œì»¬)', lb_note:'ë­í‚¹ì€ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤(localStorage).', play_again:'ë‹¤ì‹œ í•˜ê¸°',
    show_stats:'ğŸ“Š í†µê³„ ë³´ê¸°', hide_stats:'ğŸ“‰ í†µê³„ ìˆ¨ê¸°ê¸°'
  },
  es:{name:'EspaÃ±ol',
    score:'Puntos', level:'Nivel', progress:'Progreso', best:'Mejor',
    combo:'Combo', mult:'Multiplicador',
    start_title:'NeoX Catch the Coins',
    start_desc:'Mueve la bandeja inferior para atrapar las monedas NeoX. <b>Moneda bonus (azul) = x3</b>; los aciertos consecutivos aumentan el <b>Combo</b> (mÃ¡x x3); fallar resta puntos y reinicia el Combo. Completa los objetivos para subir de nivel (5 niveles). Al completar, puedes guardar tu nombre en la clasificaciÃ³n local.',
    start_btn:'Jugar', sound:'Sonido', pause_btn:'Pausa', resume_btn:'Seguir', restart_btn:'Reiniciar',
    paused_title:'Pausado', paused_desc:'Â¿Listo para continuar?',
    win_title:'Â¡Felicidades!', save_btn:'Guardar en Ranking',
    name_ph:'Tu nombre (mÃ¡x 20)', lb_title:'Ranking (Local)', lb_note:'El ranking solo se guarda en tu navegador (localStorage).', play_again:'Jugar de nuevo',
    show_stats:'ğŸ“Š Mostrar EstadÃ­sticas', hide_stats:'ğŸ“‰ Ocultar EstadÃ­sticas'
  }
};

function getParam(name){ return new URLSearchParams(location.search).get(name); }
let lang = (getParam('lang')) || localStorage.getItem('neox_lang') || (()=> {
  const n=(navigator.language||'').toLowerCase();
  if(n.startsWith('zh-tw')||n.startsWith('zh-hk')) return 'zh-Hant';
  if(n.startsWith('zh')) return 'zh-Hans';
  if(n.startsWith('ja')) return 'ja';
  if(n.startsWith('ko')) return 'ko';
  if(n.startsWith('es')) return 'es';
  return 'en';
})();
if(!I18N[lang]) lang='en';
function t(k){ return (I18N[lang] && I18N[lang][k]) || I18N.en[k] || k; }
function setLang(next){ if(!I18N[next]) return; lang=next; localStorage.setItem('neox_lang',lang); applyLang(); refreshHUD(); }

/* ===================== Canvas/HiDPI ===================== */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fitHiDPI(){
  const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
  const isMobile = /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);
  const cap = isMobile ? 1.5 : 2;
  const dpr = Math.max(1, Math.min(window.devicePixelRatio||1, cap));
  if (canvas.width !== Math.round(cssW*dpr)) {
    canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
  }
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
fitHiDPI(); addEventListener('resize', fitHiDPI);

/* ===================== State & UI refs ===================== */
const State = { READY:0, PLAYING:1, PAUSED:2, WIN:3 };
let state = State.READY;

const scoreBadge   = document.getElementById('scoreBadge');
const levelBadge   = document.getElementById('levelBadge');
const progressBadge= document.getElementById('progressBadge');
const comboBadge   = document.getElementById('comboBadge');
const multBadge    = document.getElementById('multBadge');
const bestBadge    = document.getElementById('bestBadge');
const panelStart   = document.getElementById('panelStart');
const panelPause   = document.getElementById('panelPause');
const panelWin     = document.getElementById('panelWin');
const finalScore   = document.getElementById('finalScore');
const bestScoreEl  = document.getElementById('bestScore');
const levelBanner  = document.getElementById('levelBanner');
const lbListStart  = document.getElementById('lbListStart');
const lbListWin    = document.getElementById('lbListWin');
const nameInput    = document.getElementById('nameInput');
const langSelect   = document.getElementById('langSelect');

/* ===================== Player/Tray (Cute Chest) ===================== */
const tray = { x: 225, y: 758, w: 128, h: 26, r: 14, speed: 6.3, vx: 0 };
const chest = { open: 0.18, bump: 0 }; // 0~1

/* ===================== Coin image ===================== */
const coinImg = new Image();
coinImg.src = "https://neoxcoin.github.io/neox-emoji-128.png";
let coinReady=false; coinImg.onload=()=>coinReady=true;

/* ===================== Objects ===================== */
const coins = [];
const particles = []; // not used (tails removed)
const EMIT_TRAIL=false, EMIT_BURST=false;
function rand(a,b){ return Math.random()*(b-a)+a; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* ===================== Levels ===================== */
const LEVELS = [
  { target: 10, vy:[2.0, 2.8], spawn:[0.9, 1.2], concurrent: 2, mult:1.0 },
  { target: 25, vy:[2.6, 3.4], spawn:[0.7, 1.0], concurrent: 3, mult:1.2 },
  { target: 45, vy:[3.0, 3.8], spawn:[0.55,0.85], concurrent: 4, mult:1.4 },
  { target: 70, vy:[3.6, 4.6], spawn:[0.45,0.75], concurrent: 5, mult:1.7 },
  { target:100, vy:[4.2, 5.4], spawn:[0.36,0.66], concurrent: 6, mult:2.1 },
];
let levelIdx=0, caughtThisLevel=0;

/* ===================== Score & Leaderboard ===================== */
let score=0, best=Number(localStorage.getItem('neox_catch_best')||0);
const LB_KEY='neox_catch_leaderboard', NAME_KEY='neox_player_name';
function loadLeaderboard(){ try{ return JSON.parse(localStorage.getItem(LB_KEY)||'[]'); }catch(e){ return []; } }
function saveLeaderboard(lb){ localStorage.setItem(LB_KEY, JSON.stringify(lb)); }
function renderLeaderboard(listEl, lb){
  listEl.innerHTML=''; if(!lb.length){ listEl.innerHTML='<li>(no records)</li>'; return; }
  lb.slice(0,5).forEach((it,i)=>{ const li=document.createElement('li'); li.textContent=`${i+1}. ${it.name} â€” ${it.score}`; listEl.appendChild(li); });
}
function maybeRecordScore(finalScore){
  const lb = loadLeaderboard();
  const nameDefault = localStorage.getItem(NAME_KEY)||''; nameInput.value=nameDefault; setTimeout(()=>nameInput.focus(),50);
  renderLeaderboard(lbListWin, lb);
  document.getElementById('btnSaveScore').onclick = ()=>{
    const name=(nameInput.value||'Player').trim().slice(0,20);
    localStorage.setItem(NAME_KEY,name);
    const entry={name, score:Math.floor(finalScore), ts:Date.now()};
    lb.push(entry); lb.sort((a,b)=> b.score-a.score || a.ts-b.ts);
    saveLeaderboard(lb.slice(0,5)); renderLeaderboard(lbListWin,loadLeaderboard()); renderLeaderboard(lbListStart,loadLeaderboard());
  };
}
renderLeaderboard(lbListStart, loadLeaderboard());

/* ===================== Sound (WebAudio) ===================== */
let audioCtx=null, masterGain=null; let soundOn=true;
function ensureAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.8; masterGain.connect(audioCtx.destination); }
async function resumeAudio(){ try{ ensureAudio(); if(audioCtx.state!=='running') await audioCtx.resume(); }catch(e){} }
function beep({freq=440,dur=0.12,type='sine',gain=0.2,decay=0.02,start=0}){ if(!soundOn||!audioCtx) return; const now=audioCtx.currentTime+start; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.setValueAtTime(freq,now); g.gain.setValueAtTime(gain,now); g.gain.exponentialRampToValueAtTime(0.0001, now+Math.max(0.01,dur-decay)); o.connect(g).connect(masterGain); o.start(now); o.stop(now+dur); }
const SFX={ click(){beep({freq:700,dur:0.07,type:'triangle',gain:0.12});}, catch(){beep({freq:880,dur:0.08,gain:0.18}); beep({freq:1320,dur:0.10,gain:0.12,start:0.04});}, level(){beep({freq:500,dur:0.10,type:'square',gain:0.15}); beep({freq:750,dur:0.12,type:'square',gain:0.15,start:0.08}); beep({freq:1100,dur:0.14,type:'square',gain:0.12,start:0.16});}, win(){[660,880,990,1320].forEach((f,i)=>beep({freq:f,dur:0.14,gain:0.14,start:i*0.09}));}, toggle(on){ on?beep({freq:900,dur:0.07,type:'triangle',gain:0.15}):beep({freq:300,dur:0.12,type:'triangle',gain:0.12}); } };

/* ===================== UI helpers ===================== */
function show(el,s=true){ el.classList.toggle('hidden',!s); }
function flashLevelBanner(text){ levelBanner.textContent=text; show(levelBanner,true); setTimeout(()=>show(levelBanner,false),1100); }
function refreshHUD(){
  scoreBadge.textContent    = `${t('score')}: ${Math.floor(score)}`;
  levelBadge.textContent    = `${t('level')} ${levelIdx+1} / 5`;
  progressBadge.textContent = `${t('progress')}: ${caughtThisLevel} / ${LEVELS[levelIdx].target}`;
  comboBadge.textContent    = `${t('combo')}: 0`;
  multBadge.textContent     = `${t('mult')}: x1.0`;
  bestBadge.textContent     = `${t('best')}: ${Math.floor(best)}`;
  finalScore.textContent    = `${t('score')}: ${Math.floor(score)}`;
  bestScoreEl.textContent   = `${t('best')}: ${Math.floor(best)}`;
}

/* Buttons */
document.getElementById('btnStart').onclick   = ()=>{ SFX.click(); start(); };
document.getElementById('btnPause').onclick   = ()=>{ SFX.click(); togglePause(); };
document.getElementById('btnResume').onclick  = ()=>{ SFX.click(); togglePause(false); };
document.getElementById('btnRestart').onclick = ()=>{ SFX.click(); restart(); };
document.getElementById('btnRestart2').onclick= ()=>{ SFX.click(); restart(); };
document.getElementById('btnPlayAgain').onclick=()=>{ SFX.click(); restart(); };

const btnSound = document.getElementById('btnSound');
btnSound.addEventListener('click', async ()=>{ await resumeAudio(); soundOn=!soundOn; btnSound.textContent=(soundOn?'ğŸ”Š ':'ğŸ”ˆ ')+t('sound'); SFX.toggle(soundOn); });

/* HUD å±•é–‹/æ”¶èµ· */
const hudBar = document.getElementById('hudBar');
const btnShowMore = document.getElementById('btnShowMore');
let showAllStats=false;
function updateStatsButton(){ if(btnShowMore) btnShowMore.textContent = showAllStats ? t('hide_stats') : t('show_stats'); }
btnShowMore.addEventListener('click', ()=>{ showAllStats=!showAllStats; hudBar.classList.toggle('show-all', showAllStats); updateStatsButton(); });

/* ===================== Input ===================== */
const keys=new Set();
addEventListener('keydown', e=>{
  if(e.repeat) return;
  if(e.key==='ArrowLeft') keys.add('L');
  if(e.key==='ArrowRight') keys.add('R');
  if(e.key.toLowerCase()==='p') togglePause();
  if(e.key.toLowerCase()==='r') restart();
  if(e.key.toLowerCase()==='m') btnSound.click();
  if(state===State.READY && (e.key===' '||e.key==='Enter')) start();
});
addEventListener('keyup', e=>{ if(e.key==='ArrowLeft') keys.delete('L'); if(e.key==='ArrowRight') keys.delete('R'); });

// Touch drag
let pointerId=null;
function onPointerDown(e){ const p=(e.changedTouches&&e.changedTouches[0])||e; pointerId=p.identifier??'mouse'; if(state===State.READY) start(); e.preventDefault(); }
function onPointerMove(e){
  const p=(e.changedTouches && ([...e.changedTouches].find(t => (t.identifier ?? 'mouse')===pointerId)))||e; if(!p) return;
  const rect=canvas.getBoundingClientRect(); const cx=(p.clientX-rect.left)/rect.width*canvas.clientWidth; const diff=cx-tray.x;
  tray.vx = clamp(diff*0.25, -tray.speed, tray.speed); e.preventDefault();
}
function onPointerUp(e){ pointerId=null; tray.vx=0; e.preventDefault(); }
canvas.addEventListener('pointerdown', onPointerDown, {passive:false});
addEventListener('pointermove', onPointerMove, {passive:false});
addEventListener('pointerup', onPointerUp, {passive:false});
addEventListener('pointercancel', onPointerUp, {passive:false});

// First interaction enables audio
['pointerdown','keydown'].forEach(evt=>{ window.addEventListener(evt, resumeAudio, {once:true, passive:true}); });
addEventListener('blur', ()=>{ if(state===State.PLAYING) togglePause(true); });

/* ===================== Flow ===================== */
let spawnTimer=0;
function start(){
  score=0; best=Number(localStorage.getItem('neox_catch_best')||0);
  levelIdx=0; caughtThisLevel=0; coins.length=0; particles.length=0; spawnTimer=0;
  tray.x = canvas.clientWidth/2; tray.vx=0; tray.y = canvas.clientHeight - 28;
  const W = canvas.clientWidth; tray.speed = W<420 ? 5.2 : 6.3;
  chest.open=0.18; chest.bump=0;
  state=State.PLAYING; show(panelStart,false); show(panelPause,false); show(panelWin,false);
  flashLevelBanner('LEVEL 1'); refreshHUD();
}
function togglePause(forcePause){
  if(state===State.PLAYING && (forcePause ?? true)){ state=State.PAUSED; show(panelPause,true); document.getElementById('btnPause').textContent='âµ '+t('resume_btn'); }
  else if(state===State.PAUSED){ state=State.PLAYING; show(panelPause,false); document.getElementById('btnPause').textContent='â¸ '+t('pause_btn'); }
}
function win(){
  state=State.WIN; best=Math.max(best, Math.floor(score)); localStorage.setItem('neox_catch_best', String(best));
  refreshHUD(); SFX.win(); show(panelWin,true); maybeRecordScore(score);
}
function restart(){ show(panelWin,false); show(panelPause,false); start(); }

/* Spawn coins */
function spawnCoins(dt){
  const L=LEVELS[levelIdx]; spawnTimer-=dt; const currentMax=L.concurrent;
  if(spawnTimer<=0 && coins.length<currentMax){
    coins.push({ x:rand(18, canvas.clientWidth-18), y:-20, r:12, vy:rand(L.vy[0], L.vy[1]), spin:rand(0,Math.PI*2), vspin:rand(-0.12,0.12) });
    spawnTimer = rand(L.spawn[0], L.spawn[1]);
  }
}

/* ===================== Drawing ===================== */
function drawBackground(t){
  const w=canvas.clientWidth, h=canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  const g = ctx.createRadialGradient(w*0.5, h*0.25, 20, w*0.5, h*0.25, h*0.95);
  g.addColorStop(0,'rgba(90,180,255,0.10)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  ctx.globalAlpha=0.6; ctx.fillStyle='rgba(255,255,255,0.8)';
  for(let i=0;i<40;i++){ const x=(t*0.02 + i*97)%w; const y=(t*0.06 + i*53)%h; ctx.fillRect(x,y,1,1); }
  ctx.globalAlpha=1;
}
function roundRect(x,y,w,h,r,fill){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill){ctx.fillStyle=fill; ctx.fill();} else ctx.stroke(); }

// Cute golden chest tray
function drawChestTray(){
  const x=tray.x, y=tray.y, w=tray.w, h=tray.h, r=Math.min(16,h*0.9);
  const glow=ctx.createRadialGradient(x,y,6,x,y,96); glow.addColorStop(0,'rgba(255,196,64,0.40)'); glow.addColorStop(1,'rgba(255,196,64,0)'); ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(x,y,74,0,Math.PI*2); ctx.fill();
  const bumpY = -Math.sin(chest.bump*Math.PI)*2.5; const tY=y+bumpY;

  // base
  roundRect(x-w/2, tY-h*0.95, w, h*0.95, r, '#6b4a00');
  roundRect(x-w/2, tY-h*0.95, w, h*0.95, r, 'rgba(255,205,80,0.95)');
  ctx.lineWidth=2; ctx.strokeStyle='rgba(140,80,0,0.35)'; ctx.stroke();

  // inner glass
  const glassH=h*0.58, gy=tY-glassH*0.65;
  const glassGrad=ctx.createLinearGradient(0, gy-glassH/2, 0, gy+glassH/2);
  glassGrad.addColorStop(0,'rgba(255,255,255,0.18)'); glassGrad.addColorStop(1,'rgba(255,255,255,0.05)');
  roundRect(x-w*0.46, gy-glassH/2, w*0.92, glassH, h*0.2, glassGrad);
  ctx.beginPath(); ctx.moveTo(x-w*0.40, gy-glassH*0.35); ctx.lineTo(x-w*0.10, gy-glassH*0.15); ctx.lineTo(x-w*0.40, gy+glassH*0.05); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.12)'; ctx.fill();
  ctx.strokeStyle='rgba(255,230,160,0.9)'; ctx.lineWidth=1.2; ctx.beginPath(); ctx.moveTo(x-w*0.46, tY-h*0.72); ctx.lineTo(x+w*0.46, tY-h*0.72); ctx.stroke();

  // lid
  const lidOpen = Math.max(0, Math.min(1, chest.open));
  const lidAngle = -Math.PI/7 * lidOpen; const lidH=h*0.80, lidW=w*0.92;
  ctx.save();
  const hingeX=x, hingeY=tY-h*0.95;
  ctx.translate(hingeX, hingeY); ctx.rotate(lidAngle); ctx.translate(-hingeX, -hingeY);
  roundRect(hingeX-lidW/2, hingeY-lidH, lidW, lidH, h*0.22, 'rgba(255,205,80,0.95)');
  ctx.lineWidth=2; ctx.strokeStyle='rgba(140,80,0,0.35)'; ctx.stroke();
  const lidGlass=ctx.createLinearGradient(0, hingeY-lidH, 0, hingeY);
  lidGlass.addColorStop(0,'rgba(255,255,255,0.16)'); lidGlass.addColorStop(1,'rgba(255,255,255,0.05)');
  roundRect(hingeX-lidW*0.46, hingeY-lidH*0.86, lidW*0.92, lidH*0.72, h*0.18, lidGlass);
  roundRect(hingeX-10, hingeY-lidH*0.12, 20, 10, 4, 'rgba(255,220,120,0.95)');
  ctx.restore();
}

function drawCoins(){ for(const c of coins){ drawCoin(c.x,c.y,c.r*3,c.spin); } }
function drawCoin(x,y,size,rot){
  const r=size/2; ctx.save(); ctx.translate(x,y); ctx.rotate(rot);
  const g=ctx.createRadialGradient(0,0,0,0,0,r*0.9); g.addColorStop(0,'rgba(255,230,160,.9)'); g.addColorStop(1,'rgba(255,230,160,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r*0.95,0,Math.PI*2); ctx.fill();
  if(coinReady) ctx.drawImage(coinImg, -r, -r, size, size);
  else { const grad=ctx.createRadialGradient(0,0,r*0.2,0,0,r); grad.addColorStop(0,'#fff6cc'); grad.addColorStop(1,'#e3b23c'); ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#402f00'; ctx.font=`${r*1.2}px Arial Black`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('N',0,2); }
  ctx.restore();
}

/* ===================== Loop ===================== */
let last=performance.now();
function loop(now){
  requestAnimationFrame(loop);
  fitHiDPI();
  const dt=Math.min(50, now-last)/16.6667; last=now;

  drawBackground(now);

  if(state===State.PLAYING){
    tray.vx = (keys.has('L')?-tray.speed:0) + (keys.has('R')?tray.speed:0) || tray.vx*0.9;
    tray.x += tray.vx; tray.x = clamp(tray.x, tray.w/2+10, canvas.clientWidth - tray.w/2 - 10);
    tray.y = canvas.clientHeight - 28;

    spawnCoins(dt);
    for(let c of coins){ c.y += c.vy*dt; c.spin += c.vspin*dt; }

    // collisions
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i];
      const rx=tray.x-tray.w/2, ry=tray.y-tray.h/2, rw=tray.w, rh=tray.h;
      const nx=clamp(c.x, rx, rx+rw), ny=clamp(c.y, ry, ry+rh);
      const dx=c.x-nx, dy=c.y-ny;
      if(dx*dx+dy*dy <= c.r*c.r){
        const mult = LEVELS[levelIdx].mult;
        score += Math.round(10*mult);
        caughtThisLevel++;
        coins.splice(i,1);
        SFX.catch();
        // chest animation
        chest.open = Math.min(1, chest.open + 0.28);
        chest.bump = 1;

        if(caughtThisLevel >= LEVELS[levelIdx].target){
          if(levelIdx<LEVELS.length-1){ levelIdx++; caughtThisLevel=0; flashLevelBanner(`LEVEL ${levelIdx+1}`); SFX.level(); }
          else { win(); }
        }
        refreshHUD();
      } else if (c.y > canvas.clientHeight + 30){
        coins.splice(i,1);
      }
    }

    // chest easing
    chest.open += (0.18 - chest.open)*0.08;
    if(chest.bump>0) chest.bump=Math.max(0, chest.bump-0.12);
  }

  drawChestTray();
  drawCoins();

  if(state===State.READY){
    tipText('Tap or press Space to Start', canvas.clientWidth/2, canvas.clientHeight*0.62);
  }
}
requestAnimationFrame(loop);

function tipText(text,x,y){ ctx.font='600 18px system-ui, -apple-system, "Segoe UI"'; ctx.textAlign='center'; ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fillText(text,x,y); }

/* ===================== Language apply ===================== */
function applyLang(){
  // build dropdown once
  if(langSelect && !langSelect.options.length){
    langSelect.innerHTML = Object.entries(I18N).map(([code,data])=>`<option value="${code}">${data.name}</option>`).join('');
    langSelect.value = lang;
    langSelect.addEventListener('change', e=> setLang(e.target.value));
  } else if(langSelect) langSelect.value = lang;

  // top buttons
  btnSound.textContent  = (soundOn?'ğŸ”Š ':'ğŸ”ˆ ')+t('sound');
  document.getElementById('btnPause').textContent = state===State.PAUSED ? ('âµ '+t('resume_btn')) : ('â¸ '+t('pause_btn'));
  document.getElementById('btnRestart').textContent = 'ğŸ”„ '+t('restart_btn');
  const br2=document.getElementById('btnRestart2'); if(br2) br2.textContent='ğŸ”„ '+t('restart_btn');
  const brs=document.getElementById('btnResume'); if(brs) brs.textContent='âµ '+t('resume_btn');
  const pAg=document.getElementById('btnPlayAgain'); if(pAg) pAg.textContent=t('play_again');
  const bSt=document.getElementById('btnStart'); if(bSt) bSt.textContent='â–¶ '+t('start_btn');

  // panels
  const ps=document.getElementById('panelStart'); if(ps){ const h1=ps.querySelector('h1'); const p=ps.querySelector('p'); if(h1) h1.textContent=t('start_title'); if(p) p.innerHTML=t('start_desc'); const lb= document.getElementById('startLeaderboard'); if(lb){ const h3=lb.querySelector('h3'); const note=lb.querySelector('.note'); if(h3) h3.textContent='ğŸ† '+t('lb_title'); if(note) note.textContent=t('lb_note'); } }
  const pp=document.getElementById('panelPause'); if(pp){ const h1=pp.querySelector('h1'); const p=pp.querySelector('p'); if(h1) h1.textContent=t('paused_title'); if(p) p.textContent=t('paused_desc'); }
  const pw=document.getElementById('panelWin'); if(pw){ const h1=pw.querySelector('h1'); if(h1) h1.textContent=t('win_title'); const sbtn=document.getElementById('btnSaveScore'); if(sbtn) sbtn.textContent='ğŸ’¾ '+t('save_btn'); const ni=document.getElementById('nameInput'); if(ni) ni.placeholder=t('name_ph'); const h3=pw.querySelector('h3'); if(h3) h3.textContent='ğŸ“ '+t('lb_title'); }

  updateStatsButton(); // ğŸ“Š/ğŸ“‰
}
applyLang();

/* ===================== Splash ===================== */
const splash=document.getElementById('splash'); const neoxLogo=document.getElementById('neoxLogo'); const splashHint=document.getElementById('splashHint');
requestAnimationFrame(()=>{ neoxLogo.style.opacity='1'; neoxLogo.style.transform='translateY(0) scale(1)'; splashHint.style.opacity='1'; });
setTimeout(()=>{ if(!splash) return; splash.style.transition='opacity .5s ease'; splash.style.opacity='0'; setTimeout(()=> splash.style.display='none', 520); }, 1000);

</script>
</body>
</html>
